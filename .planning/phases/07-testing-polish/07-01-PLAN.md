---
phase: 07-testing-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [js/quote-form.js]
autonomous: true

must_haves:
  truths:
    - "Voice recording works in Safari (uses audio/mp4 format automatically)"
    - "User sees clear error message when microphone access is denied"
    - "User sees clear error message when MediaRecorder is not supported"
    - "Form submits successfully without voice recording"
    - "WhatsApp message contains properly encoded special characters"
  artifacts:
    - path: "js/quote-form.js"
      provides: "Cross-browser MediaRecorder support with format detection"
      contains: "isTypeSupported"
  key_links:
    - from: "js/quote-form.js"
      to: "MediaRecorder API"
      via: "format detection before instantiation"
      pattern: "isTypeSupported"
---

<objective>
Add cross-browser compatibility and edge case handling to the quote form JavaScript.

Purpose: Ensure voice recording works in Safari (which requires audio/mp4) and handle all edge cases gracefully with clear error messages.
Output: Updated quote-form.js with format detection, progressive enhancement, and robust error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-testing-polish/07-RESEARCH.md
@js/quote-form.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MediaRecorder format detection for Safari compatibility</name>
  <files>js/quote-form.js</files>
  <action>
Add a getSupportedMimeType() function that detects supported audio formats in preference order:
1. 'audio/webm;codecs=opus' (Chrome/Firefox preference)
2. 'audio/webm' (generic webm)
3. 'audio/mp4' (Safari preference)
4. '' (let browser choose default)

Use MediaRecorder.isTypeSupported() to check each format.

Update startRecording() to:
1. Call getSupportedMimeType() before creating MediaRecorder
2. Pass the detected mimeType in options: { mimeType } if a type is detected
3. Use empty options {} if no type detected (browser default)
4. Update the Blob creation in onstop to use the actual mimeType from mediaRecorder.mimeType

This ensures Safari uses audio/mp4 while Chrome/Firefox use audio/webm.
  </action>
  <verify>
Verify the code change:
- getSupportedMimeType function exists with isTypeSupported checks
- startRecording uses the detected mimeType
- Blob creation handles variable mimeType
  </verify>
  <done>MediaRecorder uses format detection, Safari gets audio/mp4, Chrome/Firefox get audio/webm</done>
</task>

<task type="auto">
  <name>Task 2: Implement progressive enhancement and robust error handling</name>
  <files>js/quote-form.js</files>
  <action>
Update the voice recording section to handle all edge cases:

1. **Progressive enhancement for voice section:**
   - Check for MediaRecorder support: `typeof MediaRecorder === 'undefined'`
   - If not supported, hide voice section entirely (already done for getUserMedia, add MediaRecorder check)

2. **Robust error handling in startRecording:**
   Add specific error handling based on error.name:
   - 'NotAllowedError' or 'PermissionDeniedError': "Microphone access denied. Allow microphone in browser settings to record."
   - 'NotFoundError': "No microphone found. Connect a microphone to record."
   - 'NotSupportedError': "Voice recording not supported in this browser."
   - Default: "Could not start recording. Voice message unavailable."

3. **Form submission without voice:**
   - Already handles if (voiceBlob) check - verify this works
   - Ensure no errors thrown when voiceBlob is null

4. **Update voice file extension based on mimeType:**
   - If mimeType includes 'mp4', use 'voice-message.mp4'
   - Otherwise use 'voice-message.webm'
  </action>
  <verify>
Check error handling code exists for each error type.
Check voice section hide logic includes MediaRecorder check.
Check form submission handles null voiceBlob.
  </verify>
  <done>Voice recording gracefully handles all edge cases with clear user feedback</done>
</task>

<task type="auto">
  <name>Task 3: Verify WhatsApp URL encoding handles special characters</name>
  <files>js/quote-form.js</files>
  <action>
Review the buildWhatsAppMessage() and whatsappBtn click handler:

1. Verify encodeURIComponent() is used on the full message (already done)
2. The message includes asterisks (*) for WhatsApp bold formatting - verify these are preserved
3. Newlines (\n) are encoded properly

The existing implementation looks correct. Just verify by reading the code and confirm no changes needed, OR fix if issues found.

If the WhatsApp button should be disabled when required fields are empty, add validation:
- Check name, phone, and service fields have values
- Show error if clicking WhatsApp with empty required fields
  </action>
  <verify>
Read the WhatsApp handler code and confirm encodeURIComponent is applied to the message.
Optionally test with special characters like quotes and ampersands.
  </verify>
  <done>WhatsApp message properly encodes all special characters and formatting</done>
</task>

</tasks>

<verification>
After all tasks:
1. Read js/quote-form.js and verify:
   - getSupportedMimeType function exists
   - Error handling covers NotAllowedError, NotFoundError, NotSupportedError
   - Voice section hidden if MediaRecorder unsupported
   - encodeURIComponent used for WhatsApp message

2. The code should work in:
   - Chrome (uses audio/webm)
   - Firefox (uses audio/webm)
   - Safari (uses audio/mp4)
</verification>

<success_criteria>
- MediaRecorder format detection implemented with isTypeSupported()
- Safari compatibility ensured via audio/mp4 fallback
- Clear error messages for microphone denied, not found, and not supported
- Voice section hidden when MediaRecorder unavailable
- Form submission works with or without voice recording
- WhatsApp URL properly encoded
</success_criteria>

<output>
After completion, create `.planning/phases/07-testing-polish/07-01-SUMMARY.md`
</output>
