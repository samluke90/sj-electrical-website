---
phase: 05-form-functionality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - quote.html
  - js/quote-form.js
  - css/styles.css
autonomous: true
user_setup:
  - service: formspree
    why: "Form backend to receive submissions and deliver to info@sjec.uk"
    env_vars: []
    dashboard_config:
      - task: "Create a new form in Formspree dashboard"
        location: "https://formspree.io/forms -> New Form"
      - task: "Copy the form endpoint ID (e.g., 'xyzabcde' from https://formspree.io/f/xyzabcde)"
        location: "Form settings page after creation"
      - task: "Set notification email to info@sjec.uk"
        location: "Form Settings -> Email"

must_haves:
  truths:
    - "User can fill out quote form and click submit"
    - "Form data is sent to Formspree endpoint"
    - "User sees success message after successful submission"
    - "User sees error message if submission fails"
    - "Form validates required fields before submission"
  artifacts:
    - path: "quote.html"
      provides: "Form with Formspree endpoint, honeypot, error container"
      contains: "formspree.io/f/"
    - path: "js/quote-form.js"
      provides: "AJAX submission with error handling"
      contains: "Accept.*application/json"
    - path: "css/styles.css"
      provides: "Error message and container styles"
      contains: ".form-error"
  key_links:
    - from: "quote.html"
      to: "js/quote-form.js"
      via: "form#quoteForm submit event"
      pattern: "quoteForm.*addEventListener.*submit"
    - from: "js/quote-form.js"
      to: "formspree.io"
      via: "fetch with Accept: application/json"
      pattern: "fetch.*Accept.*application/json"
    - from: "js/quote-form.js"
      to: "#form-errors"
      via: "showError function"
      pattern: "form-errors"
---

<objective>
Implement functional form submission via Formspree with proper validation, error handling, and success feedback.

Purpose: Enable users to submit quote requests that get delivered to info@sjec.uk, completing the core functionality of the quote page.

Output: Working form submission with accessible error messages, loading states, and success confirmation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-form-functionality/05-CONTEXT.md
@.planning/phases/05-form-functionality/05-RESEARCH.md

# Current files
@quote.html
@js/quote-form.js
@css/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update form HTML for Formspree</name>
  <files>quote.html</files>
  <action>
    Modify quote.html to replace Web3Forms configuration with Formspree:

    1. Replace the form action attribute:
       - Change `action="https://api.web3forms.com/submit"` to `action="https://formspree.io/f/YOUR_FORM_ID"`
       - Note: The actual form ID will be provided by user during execution (placeholder for now)

    2. Replace Web3Forms hidden fields (lines 91-94) with Formspree fields:
       ```html
       <!-- Formspree Configuration -->
       <input type="hidden" name="_subject" value="New Quote Request - SJ Electrical Contractors">
       <input type="hidden" name="_replyto" id="replyto">

       <!-- Honeypot spam protection (must be hidden and empty) -->
       <input type="text" name="_gotcha" style="display:none" tabindex="-1" autocomplete="off">
       ```

    3. Add accessible error container BEFORE the form (inside .quote-form-card, before the form element):
       ```html
       <!-- Error Container (accessible) -->
       <div id="form-errors" class="form-error-container" role="alert" aria-live="assertive" aria-atomic="true"></div>
       ```

    4. Update success message text (line 85) to match CONTEXT.md:
       - Change "Thank you for your enquiry..." to "Thanks! We'll be in touch within 24 hours."
  </action>
  <verify>
    - Open quote.html in browser, view source
    - Confirm form action contains "formspree.io/f/"
    - Confirm _gotcha honeypot field exists with display:none
    - Confirm _subject and _replyto hidden fields exist
    - Confirm #form-errors container exists with role="alert"
    - Confirm success message updated
  </verify>
  <done>
    Form HTML configured for Formspree with honeypot spam protection and accessible error container.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update JavaScript for Formspree submission</name>
  <files>js/quote-form.js</files>
  <action>
    Rewrite the form submission handler in quote-form.js to work with Formspree:

    1. Add error handling functions at the top (after variable declarations):
       ```javascript
       /* ============================================
          Error Display Functions
          ============================================ */
       const errorContainer = document.getElementById('form-errors');

       function showError(message) {
           errorContainer.textContent = message;
           errorContainer.classList.add('visible');
           errorContainer.setAttribute('tabindex', '-1');
           errorContainer.focus();
           // Scroll error into view
           errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
       }

       function clearErrors() {
           errorContainer.textContent = '';
           errorContainer.classList.remove('visible');
       }
       ```

    2. Replace the form submission handler (lines 128-171) with Formspree-compatible version:
       ```javascript
       /* ============================================
          Form Submission
          ============================================ */
       quoteForm.addEventListener('submit', async function(e) {
           e.preventDefault();

           // Clear previous errors
           clearErrors();

           // Client-side validation
           if (!quoteForm.checkValidity()) {
               quoteForm.reportValidity();
               return;
           }

           // Set loading state
           const originalBtnText = submitBtn.innerHTML;
           submitBtn.disabled = true;
           submitBtn.innerHTML = 'Sending...';
           submitBtn.setAttribute('aria-busy', 'true');

           try {
               const formData = new FormData(quoteForm);

               // Set reply-to from email field
               const email = quoteForm.querySelector('#email').value;
               formData.set('_replyto', email);

               // Remove existing photos and re-add from our array
               formData.delete('photos');
               uploadedFiles.forEach((file, index) => {
                   formData.append(`photo_${index + 1}`, file);
               });

               // Submit to Formspree with JSON response
               const response = await fetch(quoteForm.action, {
                   method: 'POST',
                   body: formData,
                   headers: {
                       'Accept': 'application/json'
                   }
               });

               if (response.ok) {
                   // Success - show confirmation
                   quoteForm.style.display = 'none';
                   formSuccess.classList.add('show');
                   formSuccess.scrollIntoView({ behavior: 'smooth', block: 'center' });
               } else {
                   // Handle Formspree error response
                   const data = await response.json();
                   if (data.errors) {
                       showError(data.errors.map(err => err.message).join('. '));
                   } else {
                       showError('Something went wrong. Please try again or call us directly on 07875 210 678.');
                   }
                   resetButton();
               }
           } catch (error) {
               console.error('Form submission error:', error);
               showError('Network error. Please check your connection and try again, or call us directly on 07875 210 678.');
               resetButton();
           }

           function resetButton() {
               submitBtn.disabled = false;
               submitBtn.innerHTML = originalBtnText;
               submitBtn.setAttribute('aria-busy', 'false');
           }
       });
       ```

    3. Update the validateInput function (lines 190-198) to use CSS class instead of inline style:
       ```javascript
       function validateInput(input) {
           if (!input.value.trim()) {
               input.classList.add('error');
               input.setAttribute('aria-invalid', 'true');
           } else {
               input.classList.remove('error');
               input.removeAttribute('aria-invalid');
           }
       }
       ```

    4. Replace all `alert()` calls in file handling with showError():
       - Line 55: `alert(\`Maximum ${MAX_FILES} photos...\`)` -> `showError(\`Maximum ${MAX_FILES} photos allowed.\`)`
       - Line 61: `alert(\`${file.name} is not a valid...\`)` -> `showError(\`${file.name} is not a valid image file.\`)`
       - Line 66: `alert(\`${file.name} is too large...\`)` -> `showError(\`${file.name} is too large. Maximum file size is 5MB.\`)`
  </action>
  <verify>
    - Open browser developer console
    - Fill form partially and submit - should show validation errors
    - Check that errors appear in #form-errors container (not alert())
    - Check submit button shows "Sending..." during submission
    - Verify aria-busy attribute toggles on button
  </verify>
  <done>
    JavaScript handles Formspree submission with proper error display, loading states, and accessible feedback.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CSS for error states</name>
  <files>css/styles.css</files>
  <action>
    Add CSS rules for error display in styles.css. Add these rules after the existing `.form-success` styles (around line 1296):

    ```css
    /* Form Error Container */
    .form-error-container {
        display: none;
        background: rgba(255, 82, 82, 0.1);
        border: 2px solid var(--color-error);
        border-radius: var(--radius);
        padding: 16px 20px;
        margin-bottom: 20px;
        color: var(--color-error);
        font-weight: 500;
    }

    .form-error-container.visible {
        display: block;
    }

    /* Form field error state */
    .form-control.error {
        border-color: var(--color-error);
        background: rgba(255, 82, 82, 0.05);
    }

    .form-control.error:focus {
        border-color: var(--color-error);
        box-shadow: 0 0 0 3px rgba(255, 82, 82, 0.2);
    }

    /* Inline field error message (for future enhancement) */
    .field-error {
        display: block;
        color: var(--color-error);
        font-size: 0.85rem;
        margin-top: 6px;
    }
    ```

    Also ensure the light mode overrides include error styling by adding after the light mode form-control rules (around line 1777):

    ```css
    [data-theme="light"] .form-error-container {
        background: rgba(255, 82, 82, 0.08);
    }

    [data-theme="light"] .form-control.error {
        background: rgba(255, 82, 82, 0.05);
    }
    ```
  </action>
  <verify>
    - Open quote.html in browser
    - Trigger an error (disconnect network, try to submit)
    - Verify error container appears with red border and background
    - Toggle light mode - verify error styling still visible
    - Verify form field with error class has red border
  </verify>
  <done>
    Error container and field error styles added for both dark and light modes.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Visual check:** Open quote.html in browser, verify form displays correctly
2. **Validation test:** Leave required fields empty, click submit - should show native validation
3. **Error display test:** With valid form, disconnect network and submit - error should appear in container (not alert)
4. **Loading state test:** Submit form - button should disable and show "Sending..."
5. **Success test:** With Formspree ID configured and network connected, submit form - should show success message
6. **Accessibility test:** Use keyboard to navigate form, verify error container gets focus when error shown
7. **Theme test:** Toggle light/dark mode, verify error styles work in both
</verification>

<success_criteria>
1. Form action points to Formspree endpoint (placeholder ID acceptable until user provides real ID)
2. Honeypot field (_gotcha) present and hidden
3. Error container exists with role="alert" and aria-live="assertive"
4. JavaScript submits with Accept: application/json header
5. Errors display in accessible container, not alert()
6. Success message shows "Thanks! We'll be in touch within 24 hours."
7. Submit button shows "Sending..." and disables during submission
8. Error styling visible in both light and dark modes
</success_criteria>

<output>
After completion, create `.planning/phases/05-form-functionality/05-01-SUMMARY.md`
</output>
