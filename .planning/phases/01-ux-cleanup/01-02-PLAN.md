---
phase: 01-ux-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - js/effects.js
  - css/styles.css
autonomous: true

must_haves:
  truths:
    - "User sees lightbulb animation on first visit to site"
    - "User navigating between pages does not see loading animation repeat"
    - "Returning visitor in same session sees no loading animation"
    - "User closing browser and reopening sees animation again"
    - "User opening second tab in same session sees no animation"
  artifacts:
    - path: "js/effects.js"
      provides: "Session-aware loader with cross-tab sync"
      contains: "sessionStorage"
      contains: "localStorage"
      contains: "shouldShowAnimation"
    - path: "css/styles.css"
      provides: "Simplified animation keyframes"
      contains: "@keyframes bulbFlicker"
  key_links:
    - from: "js/effects.js initPageLoader()"
      to: "shouldShowAnimation()"
      via: "early return check"
      pattern: "if.*shouldShowAnimation.*return"
    - from: "js/effects.js"
      to: "localStorage"
      via: "markAnimationShown()"
      pattern: "localStorage\\.setItem.*animation_shown"
---

<objective>
Implement session-based loading animation that shows once per browser session, shared across tabs, with faster timing.

Purpose: The loading animation is a brand moment but should not annoy returning visitors or slow down navigation. Cross-tab awareness prevents the animation from showing when users open multiple tabs.

Output: Loading animation that plays once per browser session (~1.2s duration), skips on subsequent visits until browser is fully closed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-ux-cleanup/01-CONTEXT.md
@.planning/phases/01-ux-cleanup/01-RESEARCH.md
@js/effects.js
@css/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session detection and cross-tab sync</name>
  <files>js/effects.js</files>
  <action>
Add session detection at the very top of effects.js (before any function calls) with cross-tab synchronization:

1. Add IIFE at line 1 (before the comment block) that runs immediately:
```javascript
// Session detection - runs immediately before anything else
(function() {
    // sessionStorage is tab-specific AND clears on browser close
    // If no marker exists, this is a fresh browser session
    if (!sessionStorage.getItem('sj_session_active')) {
        // Fresh browser session - clear any previous animation flag
        localStorage.removeItem('sj_animation_shown');
        sessionStorage.setItem('sj_session_active', 'true');
    }
})();
```

2. Add helper functions before initPageLoader():
```javascript
function shouldShowAnimation() {
    // Skip if already shown this session (any tab)
    if (localStorage.getItem('sj_animation_shown') === 'true') {
        return false;
    }
    // Skip if page already loaded (cached/fast)
    if (document.readyState === 'complete') {
        return false;
    }
    return true;
}

function markAnimationShown() {
    localStorage.setItem('sj_animation_shown', 'true');

    // Notify other tabs via BroadcastChannel (with fallback)
    try {
        if (window.BroadcastChannel) {
            const channel = new BroadcastChannel('sj_electrical_session');
            channel.postMessage({ type: 'animation_complete' });
            channel.close();
        }
    } catch (e) {
        // BroadcastChannel not available (Safari private mode)
    }
}

function listenForOtherTabs() {
    try {
        if (window.BroadcastChannel) {
            const channel = new BroadcastChannel('sj_electrical_session');
            channel.onmessage = (event) => {
                if (event.data.type === 'animation_complete') {
                    // Another tab showed animation - hide ours immediately
                    const loader = document.getElementById('pageLoader');
                    if (loader) {
                        loader.classList.add('loaded');
                        setTimeout(() => loader.remove(), 300);
                    }
                }
            };
        }
    } catch (e) {
        // Fallback: listen for localStorage changes
        window.addEventListener('storage', (event) => {
            if (event.key === 'sj_animation_shown' && event.newValue === 'true') {
                const loader = document.getElementById('pageLoader');
                if (loader) {
                    loader.classList.add('loaded');
                    setTimeout(() => loader.remove(), 300);
                }
            }
        });
    }
}
```

3. Modify initPageLoader() to use session detection:
- At very start: `if (!shouldShowAnimation()) return;`
- Remove the existing `if (document.readyState === 'complete') return;` (now in shouldShowAnimation)
- After creating loader element, call `listenForOtherTabs();`
- Change timing to be faster (see timing values below)
- Remove `playPowerOnSound();` call (minimalist aesthetic per CONTEXT.md)
- After `pageLoader.classList.add('loaded');`, call `markAnimationShown();`

4. Reduce timing values in initPageLoader():
- Initial delay: keep at 100ms
- Flicker duration: change from 1500ms to 600ms
- "On" state before fade: change from 300ms to 200ms
- Fade out: change from 500ms to 300ms
- Total: ~1200ms (down from ~2400ms)

5. Remove or comment out playPowerOnSound() function (lines 85-107) - no longer called
  </action>
  <verify>
1. Search effects.js for "sj_session_active" - should find matches
2. Search effects.js for "shouldShowAnimation" - should find definition and usage
3. Search effects.js for "markAnimationShown" - should find definition and usage
4. Search effects.js for "BroadcastChannel" - should find matches
5. Search effects.js for "playPowerOnSound" call in initPageLoader - should NOT find (removed)
  </verify>
  <done>
Session detection IIFE added at top. Helper functions added. initPageLoader checks session, uses faster timing, marks completion, and listens for cross-tab messages. Power-on sound removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Simplify animation keyframes and timing</name>
  <files>css/styles.css</files>
  <action>
Simplify the loading animation CSS for faster, cleaner effect:

1. Update bulbFlicker keyframes (around line 2016) - reduce from 15+ steps to 5-6:
```css
@keyframes bulbFlicker {
    0% { opacity: 0; }
    20% { opacity: 0.5; }
    40% { opacity: 0.2; }
    60% { opacity: 0.8; }
    80% { opacity: 0.4; }
    100% { opacity: 1; width: 100px; height: 100px; filter: blur(30px); }
}
```

2. Update filamentFlicker keyframes (around line 2033) - simplify similarly:
```css
@keyframes filamentFlicker {
    0% { background: rgba(255, 255, 255, 0.3); box-shadow: none; }
    25% { background: rgba(255, 200, 100, 0.5); box-shadow: 0 0 5px rgba(255, 200, 100, 0.5); }
    50% { background: rgba(255, 255, 255, 0.3); box-shadow: none; }
    75% { background: rgba(255, 200, 100, 0.7); box-shadow: 0 0 7px rgba(255, 200, 100, 0.5); }
    100% { background: var(--secondary); box-shadow: 0 0 10px var(--secondary); }
}
```

3. Update animation durations to match JS timing:
- `.lightbulb.flickering .bulb-glow` animation: change from 1.5s to 0.6s
- `.lightbulb.flickering .filament-wire` animations: change from 1.5s to 0.6s

4. Update page-loader transition for faster fade:
- `.page-loader` transition: change from 0.5s to 0.3s

5. Simplify or remove loader text animation (optional cleanup):
- The text animation can remain but consider reducing `textPulse` infinite animation to prevent distraction
  </action>
  <verify>
1. Search styles.css for "animation: bulbFlicker" - should show 0.6s duration
2. Count keyframe steps in bulbFlicker - should be 6 or fewer
3. Check .page-loader transition - should be 0.3s
  </verify>
  <done>
Animation keyframes simplified to 5-6 steps. Durations reduced to 0.6s flicker + 0.3s fade. Total visual time ~1.2s.
  </done>
</task>

</tasks>

<verification>
Test the complete session detection flow:

1. **First visit:** Clear browser data, visit site - animation should play (~1.2s)
2. **Same tab refresh:** Press F5 - NO animation
3. **New tab same session:** Open site in new tab - NO animation
4. **Simultaneous tabs:** Open two tabs at once - only ONE shows animation, other skips
5. **Close browser completely:** Close all browser windows, reopen, visit site - animation SHOULD play
6. **Internal navigation:** Click around between pages - NO animation on any navigation
7. **Timing check:** Animation should feel like a quick "flash" not a long wait
</verification>

<success_criteria>
- UXFX-02 satisfied: Animation shows only on first site visit per session
- UXFX-03 satisfied: No animation on internal page navigation
- Animation duration ~1.2s (down from ~2.4s)
- Cross-tab sync works (second tab skips animation)
- Browser restart triggers animation again
</success_criteria>

<output>
After completion, create `.planning/phases/01-ux-cleanup/01-02-SUMMARY.md`
</output>
